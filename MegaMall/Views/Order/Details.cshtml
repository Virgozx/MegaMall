@model MegaMall.Domain.Entities.Order

@{
    ViewData["Title"] = "Chi tiết đơn hàng #" + Model.Id;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Chi tiết đơn hàng <small class="text-muted">#@Model.Id</small></h2>
        <a asp-action="Index" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Quay lại</a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Sản phẩm</h5>
                </div>
                <!-- ... existing code ... -->

                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="ps-4">Sản phẩm</th>
                                    <th scope="col" class="text-end">Giá</th>
                                    <th scope="col" class="text-center">Số lượng</th>
                                    <th scope="col" class="text-end pe-4">Tổng</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.OrderItems)
                                {
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                @if (item.Product?.Images != null && item.Product.Images.Any())
                                                {
                                                    <img src="@item.Product.Images.First().ImageUrl" alt="@item.ProductName" class="img-thumbnail me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                                }
                                                <div>
                                                    <h6 class="mb-0">@item.ProductName</h6>
                                                    @if (!string.IsNullOrEmpty(item.Sku))
                                                    {
                                                        <small class="text-muted">SKU: @item.Sku</small>
                                                    }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end align-middle">@item.UnitPrice.ToString("N0") đ</td>
                                        <td class="text-center align-middle">@item.Quantity</td>
                                        <td class="text-end align-middle pe-4">@((item.UnitPrice * item.Quantity).ToString("N0")) đ</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Tạm tính:</strong></td>
                                    <td class="text-end pe-4">@((Model.TotalAmount + Model.DiscountAmount).ToString("N0") ) đ</td>
                                </tr>
                                @if (Model.DiscountAmount > 0)
                                {
                                    <tr>
                                        <td colspan="3" class="text-end text-success"><strong>Giảm giá (@Model.CouponCode):</strong></td>
                                        <td class="text-end text-success pe-4">-@Model.DiscountAmount.ToString("N0") đ</td>
                                    </tr>
                                }
                                <tr>
                                    <td colspan="3" class="text-end border-0"><strong>Tổng cộng:</strong></td>
                                    <td class="text-end border-0 pe-4"><strong class="text-primary fs-5">@Model.TotalAmount.ToString("N0") đ</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Thông tin đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Ngày đặt</label>
                        <p class="fw-bold">@Model.OrderDate.ToLocalTime().ToString("F")</p>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Trạng thái</label>
                        <div>
                            @switch (Model.Status)
                            {
                                case MegaMall.Domain.Enums.OrderStatus.PendingPayment:
                                    <span class="badge bg-warning text-dark">Chờ thanh toán</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.Paid:
                                    <span class="badge bg-info">Đã thanh toán</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.Processing:
                                    <span class="badge bg-primary">Đang xử lý</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.Shipped:
                                    <span class="badge bg-primary">Đang giao</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.Delivered:
                                    <span class="badge bg-success">Giao thành công</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.Cancelled:
                                    <span class="badge bg-danger">Đã hủy</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.Refunded:
                                    <span class="badge bg-secondary">Đã hoàn tiền</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.CancellationRequested:
                                    <span class="badge bg-warning">Yêu cầu hủy</span>
                                    break;
                                case MegaMall.Domain.Enums.OrderStatus.ReturnRequested:
                                    <span class="badge bg-warning">Yêu cầu trả hàng</span>
                                    break;
                                default:
                                    <span class="badge bg-secondary">@Model.Status</span>
                                    break;
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Phương thức thanh toán</label>
                        <p class="fw-bold">@Model.PaymentMethod</p>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Địa chỉ giao hàng</h5>
                </div>
                <div class="card-body">
                    <p class="mb-1 fw-bold">@Model.User?.FullName</p>
                    <p class="mb-1">@Model.ShippingAddress</p>
                    <p class="mb-1">@Model.ShippingCity</p>
                    <p class="mb-0"><i class="bi bi-telephone-fill text-muted me-2"></i>@Model.PhoneNumber</p>
                    @if (!string.IsNullOrEmpty(Model.Note))
                    {
                        <hr class="my-3">
                        <label class="text-muted small">Ghi chú</label>
                        <p class="mb-0 fst-italic">"@Model.Note"</p>
                    }
                </div>
            </div>

            <!-- Action Buttons -->
            @if (Model.Status == MegaMall.Domain.Enums.OrderStatus.PendingPayment || 
                 Model.Status == MegaMall.Domain.Enums.OrderStatus.Paid || 
                 Model.Status == MegaMall.Domain.Enums.OrderStatus.Processing)
            {
                <button type="button" class="btn btn-danger w-100 mb-3" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">
                    Hủy Đơn Hàng
                </button>
            }
            else if (Model.Status == MegaMall.Domain.Enums.OrderStatus.Delivered)
            {
                <button type="button" class="btn btn-warning w-100 mb-3" data-bs-toggle="modal" data-bs-target="#returnOrderModal">
                    Yêu Cầu Trả Hàng / Hoàn Tiền
                </button>
            }
            else if (Model.Status == MegaMall.Domain.Enums.OrderStatus.CancellationRequested)
            {
                 <div class="alert alert-warning">
                    <i class="bi bi-hourglass-split"></i> Đang chờ người bán xác nhận hủy đơn.
                    <br><strong>Lý do:</strong> @Model.CancelReason
                </div>
            }
            else if (Model.Status == MegaMall.Domain.Enums.OrderStatus.ReturnRequested)
            {
                 <div class="alert alert-warning">
                    <i class="bi bi-hourglass-split"></i> Đang chờ người bán xác nhận hoàn hàng.
                    <br><strong>Lý do:</strong> @Model.ReturnReason
                </div>
            }
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="RequestCancel" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelOrderModalLabel">Chọn Lý Do Hủy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="c1" value="Muốn thay đổi địa chỉ giao hàng" checked>
                        <label class="form-check-label" for="c1">Muốn thay đổi địa chỉ giao hàng</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="c2" value="Muốn nhập/thay đổi mã Voucher">
                        <label class="form-check-label" for="c2">Muốn nhập/thay đổi mã Voucher</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="c3" value="Muốn thay đổi sản phẩm (kích thước, màu sắc, số lượng...)">
                        <label class="form-check-label" for="c3">Muốn thay đổi sản phẩm (kích thước, màu sắc...)</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="c4" value="Thủ tục thanh toán quá rắc rối">
                        <label class="form-check-label" for="c4">Thủ tục thanh toán quá rắc rối</label>
                    </div>
                     <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="c5" value="Tìm thấy giá rẻ hơn ở chỗ khác">
                        <label class="form-check-label" for="c5">Tìm thấy giá rẻ hơn ở chỗ khác</label>
                    </div>
                    <div class="form-check mb-2">
                         <input class="form-check-input" type="radio" name="reason" id="c6" value="Đổi ý, không muốn mua nữa">
                        <label class="form-check-label" for="c6">Đổi ý, không muốn mua nữa</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-danger">Xác Nhận Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Return Order Modal -->
<div class="modal fade" id="returnOrderModal" tabindex="-1" aria-labelledby="returnOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="RequestReturn" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title" id="returnOrderModalLabel">Chọn Lý Do Trả Hàng/Hoàn Tiền</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="r1" value="Thiếu hàng" checked>
                        <label class="form-check-label" for="r1">Thiếu hàng</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="r2" value="Người bán gửi sai hàng">
                        <label class="form-check-label" for="r2">Người bán gửi sai hàng</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="r3" value="Hàng bể vỡ (do vận chuyển)">
                        <label class="form-check-label" for="r3">Hàng bể vỡ (do vận chuyển)</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="r4" value="Hàng lỗi, không hoạt động">
                        <label class="form-check-label" for="r4">Hàng lỗi, không hoạt động</label>
                    </div>
                     <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="reason" id="r5" value="Khác với mô tả">
                        <label class="form-check-label" for="r5">Khác với mô tả</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-warning">Gửi Yêu Cầu</button>
                </div>
            </form>
        </div>
    </div>
</div>
