@model IEnumerable<MegaMall.Domain.Entities.Product>

@{
    ViewData["Title"] = "Trang ch·ªß";
    var categories = ViewBag.Categories as IEnumerable<MegaMall.Domain.Entities.Category>;
    var activeCoupons = ViewBag.ActiveCoupons as List<MegaMall.Domain.Entities.Coupon>;
    
    var categoryList = new[]
    {
        new { Name = "B·∫•t ƒë·ªông s·∫£n", Icon = "https://static.chotot.com/storage/chotot-icons/svg/real_estate.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/609/609803.png" },
        new { Name = "Xe c·ªô", Icon = "https://static.chotot.com/storage/chotot-icons/svg/vehicle.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/741/741407.png" },
        new { Name = "Th√∫ c∆∞ng", Icon = "https://static.chotot.com/storage/chotot-icons/svg/pet.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/616/616408.png" },
        new { Name = "ƒê·ªì gia d·ª•ng, n·ªôi th·∫•t, c√¢y c·∫£nh", Icon = "https://static.chotot.com/storage/chotot-icons/svg/furniture.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/2558/2558012.png" },
        new { Name = "Gi·∫£i tr√≠, Th·ªÉ thao, S·ªü th√≠ch", Icon = "https://static.chotot.com/storage/chotot-icons/svg/entertainment.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/3076/3076002.png" },
        new { Name = "M·∫π v√† b√©", Icon = "https://cdn-icons-png.flaticon.com/512/3209/3209114.png", Fallback = "https://cdn-icons-png.flaticon.com/512/3209/3209114.png" },
        new { Name = "D·ªãch v·ª•, Du l·ªãch", Icon = "https://cdn-icons-png.flaticon.com/512/201/201623.png", Fallback = "https://cdn-icons-png.flaticon.com/512/201/201623.png" },
        new { Name = "Cho t·∫∑ng mi·ªÖn ph√≠", Icon = "https://static.chotot.com/storage/chotot-icons/svg/giveaway.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/3076/3076136.png" },
        new { Name = "Vi·ªác l√†m", Icon = "https://static.chotot.com/storage/chotot-icons/svg/job.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/3076/3076404.png" },
        new { Name = "ƒê·ªì ƒëi·ªán t·ª≠", Icon = "https://static.chotot.com/storage/chotot-icons/svg/electronic.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/644/644667.png" },
        new { Name = "T·ªß l·∫°nh, m√°y l·∫°nh, m√°y gi·∫∑t", Icon = "https://static.chotot.com/storage/chotot-icons/svg/fridge.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/911/911409.png" },
        new { Name = "ƒê·ªì d√πng vƒÉn ph√≤ng, c√¥ng n√¥ng nghi·ªáp", Icon = "https://cdn-icons-png.flaticon.com/512/3022/3022251.png", Fallback = "https://cdn-icons-png.flaticon.com/512/3022/3022251.png" },
        new { Name = "Th·ªùi trang, ƒê·ªì d√πng c√° nh√¢n", Icon = "https://static.chotot.com/storage/chotot-icons/svg/fashion.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/3050/3050253.png" },
        new { Name = "ƒê·ªì ƒÉn, th·ª±c ph·∫©m v√† c√°c lo·∫°i kh√°c", Icon = "https://static.chotot.com/storage/chotot-icons/svg/food.svg", Fallback = "https://cdn-icons-png.flaticon.com/512/3076/3076120.png" },
        new { Name = "D·ªãch v·ª• chƒÉm s√≥c nh√† c·ª≠a", Icon = "https://cdn-icons-png.flaticon.com/512/2942/2942083.png", Fallback = "https://cdn-icons-png.flaticon.com/512/2942/2942083.png" },
        new { Name = "T·∫•t c·∫£ danh m·ª•c", Icon = "https://cdn-icons-png.flaticon.com/512/10484/10484252.png", Fallback = "https://cdn-icons-png.flaticon.com/512/10484/10484252.png" }
    };
}

<!-- Hero Section -->
<div class="bg-success py-5 mb-4" style="background: linear-gradient(135deg, #28a745 0%, #5cb85c 50%, #28a745 100%);">
    <div class="container text-center">
        <h1 class="fw-bold display-4 mb-3 text-white">Gi√° t·ªët, g·∫ßn b·∫°n, ch·ªët nhanh!</h1>
        <p class="lead fs-5 mb-0 text-white" style="opacity: 0.9;">Kh√°m ph√° h√†ng ng√†n tin ƒëƒÉng mua b√°n m·ªói ng√†y.</p>
    </div>
</div>

<div class="container">
    <!-- Search Bar -->
    <div class="row justify-content-center mb-4" style="margin-top: -40px; position: relative; z-index: 100;">
        <div class="col-lg-10">
            <form asp-controller="Search" asp-action="Index" method="get" class="bg-white rounded shadow-lg p-2 d-flex align-items-center">
                <!-- Category Dropdown -->
                <div class="dropdown ms-2">
                    <button class="btn btn-link text-decoration-none text-dark dropdown-toggle border-0 fw-bold" type="button" id="categoryDropdownHero" data-bs-toggle="dropdown">
                        <i class="bi bi-grid-3x3-gap"></i> <span id="selectedCategoryHero">Danh m·ª•c</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="categoryDropdownHero" style="max-height: 300px; overflow-y: auto; z-index: 9000;">
                        <li><a class="dropdown-item" href="javascript:void(0)" data-category="">T·∫•t c·∫£ danh m·ª•c</a></li>
                        @if (categories != null && categories.Any())
                        {
                            foreach (var cat in categories)
                            {
                                <li><a class="dropdown-item" href="javascript:void(0)" data-category="@cat.Id">@cat.Name</a></li>
                            }
                        }
                    </ul>
                </div>
                <input type="hidden" name="categoryId" id="categoryIdHero" value="@ViewBag.CategoryId">
                
                <div class="vr mx-2"></div>
                
                <!-- Search Input -->
                <div class="position-relative flex-grow-1">
                    <input type="text" name="q" id="searchInputHero" class="form-control border-0" placeholder="T√¨m s·∫£n ph·∫©m..." style="box-shadow: none;" value="@ViewBag.SearchQuery" autocomplete="off">
                    <div id="searchSuggestions" class="position-absolute w-100 bg-white rounded shadow-lg" style="display: none; z-index: 1000; max-height: 400px; overflow-y: auto; margin-top: 2px;"></div>
                </div>
                
                <div class="vr mx-2 d-none d-md-block"></div>
                
                <!-- Location Dropdown -->
                <div class="dropdown me-2 d-none d-md-block">
                    <button class="btn btn-link text-decoration-none text-dark dropdown-toggle border-0" type="button" id="locationDropdownHero" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-geo-alt-fill text-danger"></i> <span id="selectedLocationHero">@(string.IsNullOrEmpty(ViewBag.Location) ? "To√†n qu·ªëc" : ViewBag.Location)</span>
                    </button>
                    <div class="dropdown-menu p-3 shadow" aria-labelledby="locationDropdownHero" style="min-width: 300px;">
                        <h6 class="fw-bold small mb-3"><i class="bi bi-building"></i> Ch·ªçn t·ªânh th√†nh</h6>
                        
                        <!-- Quick Select -->
                        <div class="d-flex gap-2 mb-3 flex-wrap">
                            <button type="button" class="btn btn-light btn-sm rounded-pill border location-quick-btn" data-location="Tp H·ªì Ch√≠ Minh">Tp H·ªì Ch√≠ Minh</button>
                            <button type="button" class="btn btn-light btn-sm rounded-pill border location-quick-btn" data-location="H√† N·ªôi">H√† N·ªôi</button>
                            <button type="button" class="btn btn-light btn-sm rounded-pill border location-quick-btn" data-location="ƒê√† N·∫µng">ƒê√† N·∫µng</button>
                        </div>
                        
                        <hr>
                        
                        <!-- Province List -->
                        <div class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;">
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="">To√†n qu·ªëc</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="Th√°i Nguy√™n">Th√°i Nguy√™n</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="Tp H·ªì Ch√≠ Minh">Tp H·ªì Ch√≠ Minh</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="H√† N·ªôi">H√† N·ªôi</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="ƒê√† N·∫µng">ƒê√† N·∫µng</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="C·∫ßn Th∆°">C·∫ßn Th∆°</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="B√¨nh D∆∞∆°ng">B√¨nh D∆∞∆°ng</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="ƒê·ªìng Nai">ƒê·ªìng Nai</a>
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action border-0 px-2 py-2" data-location="Kh√°nh H√≤a">Kh√°nh H√≤a</a>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="location" id="locationHero" value="@ViewBag.Location">
                <input type="hidden" name="sortBy" value="@ViewBag.SortBy">
                
                <!-- Submit Button -->
                <button class="btn btn-warning px-4 fw-bold" type="submit">
                    <i class="bi bi-search"></i> <span class="d-none d-sm-inline">T√¨m ki·∫øm</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Category Grid -->
    <div class="category-grid shadow-sm">
        @foreach (var cat in categoryList)
        {
            <div class="category-item position-relative" onclick="filterByCategory('@cat.Name')" style="cursor: pointer;">
                @if (cat.Name == "D·ªãch v·ª• chƒÉm s√≥c nh√† c·ª≠a")
                {
                    <span class="badge bg-danger rounded-pill position-absolute" style="top: -5px; right: 10px; font-size: 0.6rem;">M·ªõi</span>
                }
                
                @if (cat.Name == "T·∫•t c·∫£ danh m·ª•c")
                {
                    <div class="category-icon d-flex align-items-center justify-content-center">
                        <i class="bi bi-grid-fill text-warning" style="font-size: 2.5rem;"></i>
                    </div>
                }
                else
                {
                    <img src="@cat.Icon" class="category-icon" onerror="this.src='@cat.Fallback'">
                }
                <span class="category-name">@cat.Name</span>
            </div>
        }
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-12">
            <!-- Sort Bar -->
            <div class="d-flex align-items-center bg-light p-3 mb-3 rounded shadow-sm">
                <span class="me-3 text-muted">S·∫Øp x·∫øp theo</span>
                
                <button type="button" class="btn @(ViewBag.SortBy == "popular" || string.IsNullOrEmpty(ViewBag.SortBy as string) ? "btn-danger text-white" : "btn-white bg-white text-dark") me-2" onclick="updateSort('popular')">Ph·ªï Bi·∫øn</button>
                <button type="button" class="btn @(ViewBag.SortBy == "newest" ? "btn-danger text-white" : "btn-white bg-white text-dark") me-2" onclick="updateSort('newest')">M·ªõi Nh·∫•t</button>
                <button type="button" class="btn @(ViewBag.SortBy == "best_selling" ? "btn-danger text-white" : "btn-white bg-white text-dark") me-2" onclick="updateSort('best_selling')">B√°n Ch·∫°y</button>
                
                <div class="dropdown me-2">
                    <button id="priceSortDropdown" class="btn btn-white bg-white text-dark dropdown-toggle d-flex justify-content-between align-items-center" type="button" data-bs-toggle="dropdown" style="min-width: 200px;">
                        @if(ViewBag.SortBy == "price_asc") { <text>Gi√°: Th·∫•p ƒë·∫øn Cao</text> }
                        else if(ViewBag.SortBy == "price_desc") { <text>Gi√°: Cao ƒë·∫øn Th·∫•p</text> }
                        else { <text>Gi√°</text> }
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateSort('price_asc')">Gi√°: Th·∫•p ƒë·∫øn Cao</a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateSort('price_desc')">Gi√°: Cao ƒë·∫øn Th·∫•p</a></li>
                    </ul>
                </div>

                <div class="ms-auto d-flex align-items-center">
                    <span class="me-3"><span class="text-danger fw-bold">@(ViewBag.CurrentPage)</span>/@(ViewBag.TotalPages)</span>
                    <div class="btn-group">
                        <button type="button" class="btn btn-white bg-white border" @(ViewBag.CurrentPage <= 1 ? "disabled" : "") onclick="changePage(@(ViewBag.CurrentPage - 1))"><i class="bi bi-chevron-left"></i></button>
                        <button type="button" class="btn btn-white bg-white border" @(ViewBag.CurrentPage >= ViewBag.TotalPages ? "disabled" : "") onclick="changePage(@(ViewBag.CurrentPage + 1))"><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <div id="product-grid-section">
                <partial name="_ProductList" model="Model" />
            </div>
        </div>
    </div>

    <!-- SEO Text & Keywords -->
    <div class="mt-5 bg-white p-4 rounded shadow-sm">
        <h5 class="fw-bold mb-3">MegaMall - S√†n Th∆∞∆°ng M·∫°i ƒêi·ªán T·ª≠ H√†ng ƒê·∫ßu C·ªßa Ng∆∞·ªùi Vi·ªát</h5>
        <div class="seo-content text-muted small" style="line-height: 1.6;">
            <p>MegaMall ch√≠nh th·ª©c gia nh·∫≠p th·ªã tr∆∞·ªùng Vi·ªát Nam v√†o ƒë·∫ßu nƒÉm 2012, v·ªõi m·ª•c ƒë√≠ch t·∫°o ra cho b·∫°n m·ªôt k√™nh mua s·∫Øm tr·ª±c tuy·∫øn hi·ªán ƒë·∫°i, k·∫øt n·ªëi ng∆∞·ªùi mua v·ªõi ng∆∞·ªùi b√°n l·∫°i v·ªõi nhau b·∫±ng nh·ªØng giao d·ªãch c·ª±c k·ª≥ ƒë∆°n gi·∫£n, ti·ªán l·ª£i, nhanh ch√≥ng, an to√†n, mang ƒë·∫øn hi·ªáu qu·∫£ b·∫•t ng·ªù.</p>
            <p>ƒê·∫øn nay, MegaMall t·ª± h√†o l√† Website th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠ ƒë∆∞·ª£c ∆∞a chu·ªông h√†ng ƒë·∫ßu Vi·ªát Nam. H√†ng ng√†n s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng t·ª´ <a href="#" class="text-decoration-none">B·∫•t ƒë·ªông s·∫£n</a>, <a href="#" class="text-decoration-none">Nh√† c·ª≠a</a>, <a href="#" class="text-decoration-none">Xe c·ªô</a>, <a href="#" class="text-decoration-none">ƒê·ªì ƒëi·ªán t·ª≠</a>, Th√∫ c∆∞ng, V·∫≠t d·ª•ng c√° nh√¢n... ƒë·∫øn <a href="#" class="text-decoration-none">t√¨m vi·ªác l√†m</a>, th√¥ng tin tuy·ªÉn d·ª•ng, c√°c d·ªãch v·ª• - du l·ªãch ƒë∆∞·ª£c ƒëƒÉng b√°n tr√™n MegaMall.</p>
            <p>V·ªõi MegaMall, b·∫°n c√≥ th·ªÉ d·ªÖ d√†ng mua b√°n, trao ƒë·ªïi b·∫•t c·ª© m·ªôt lo·∫°i m·∫∑t h√†ng n√†o, d√π ƒë√≥ l√† ƒë·ªì c≈© hay ƒë·ªì m·ªõi v·ªõi nhi·ªÅu lƒ©nh v·ª±c:</p>
            <ul class="list-unstyled ms-3">
                <li><strong>B·∫•t ƒë·ªông s·∫£n:</strong> Cho thu√™, Mua b√°n <a href="#" class="text-decoration-none">nh√† ƒë·∫•t</a>, <a href="#" class="text-decoration-none">cƒÉn h·ªô chung c∆∞</a>, <a href="#" class="text-decoration-none">vƒÉn ph√≤ng m·∫∑t b·∫±ng kinh doanh</a>, ph√≤ng tr·ªç ƒëa d·∫°ng v·ªÅ di·ªán t√≠ch, v·ªã tr√≠</li>
                <li><strong>Ph∆∞∆°ng ti·ªán ƒëi l·∫°i:</strong> <a href="#" class="text-decoration-none">Mua b√°n √¥ t√¥</a>, <a href="#" class="text-decoration-none">xe m√°y</a> c√≥ ƒë·ªô b·ªÅn cao, gi√° c·∫£ h·ª£p l√Ω, gi·∫•y t·ªù ƒë·∫ßy ƒë·ªß.</li>
                <li><strong>ƒê·ªì d√πng c√° nh√¢n:</strong> Qu·∫ßn √°o, gi√†y d√©p, t√∫i x√°ch, ƒë·ªìng h·ªì... ƒëa phong c√°ch, h·ª£p th·ªùi trang.</li>
                <li><strong>ƒê·ªì ƒëi·ªán t·ª≠:</strong> <a href="#" class="text-decoration-none">ƒêi·ªán tho·∫°i di ƒë·ªông</a>, <a href="#" class="text-decoration-none">m√°y t√≠nh b·∫£ng</a>, <a href="#" class="text-decoration-none">laptop</a>, tivi, loa, amply...; ƒë·ªì ƒëi·ªán gia d·ª•ng: <a href="#" class="text-decoration-none">m√°y gi·∫∑t</a>, <a href="#" class="text-decoration-none">t·ªß l·∫°nh</a>, <a href="#" class="text-decoration-none">m√°y l·∫°nh ƒëi·ªÅu h√≤a</a>... v·ªõi r·∫•t nhi·ªÅu nh√£n hi·ªáu, k√≠ch th∆∞·ªõc kh√°c nhau.</li>
            </ul>
            <p>V√† c√≤n r·∫•t nhi·ªÅu m·∫∑t h√†ng kh√°c n·ªØa ƒë√£ v√† ƒëang ƒë∆∞·ª£c b√°n t·∫°i MegaMall.</p>
            <p>M·ªói ng∆∞·ªùi trong ch√∫ng ta ƒë·ªÅu c√≥ nh·ªØng s·∫£n ph·∫©m ƒë√£ qua s·ª≠ d·ª•ng v√† kh√¥ng c·∫ßn d√πng t·ªõi n·ªØa. V·∫≠y c√≤n ch·∫ßn ch·ª´ g√¨ n·ªØa m√† kh√¥ng ƒë·ªÉ n√≥ tr·ªü n√™n gi√° tr·ªã h∆°n v·ªõi ng∆∞·ªùi kh√°c. R·∫•t ƒë∆°n gi·∫£n, b·∫°n ch·ªâ c·∫ßn ch·ª•p h√¨nh l·∫°i, m√¥ t·∫£ c·ª• th·ªÉ v·ªÅ s·∫£n ph·∫©m v√† s·ª≠ d·ª•ng ·ª©ng d·ª•ng ƒêƒÉng tin mi·ªÖn ph√≠ c·ªßa MegaMall l√† ƒë√£ c√≥ th·ªÉ ƒë·∫øn g·∫ßn h∆°n v·ªõi ng∆∞·ªùi c·∫ßn n√≥.</p>
            <button class="btn btn-outline-secondary btn-sm mt-2">Thu g·ªçn</button>
        </div>

        <hr class="my-4">

        <h5 class="fw-bold text-muted mb-3">C√°c t·ª´ kh√≥a ph·ªï bi·∫øn</h5>
        <div class="row row-cols-2 row-cols-md-4 g-2 small text-muted">
            <div class="col"><i class="bi bi-dot"></i> iPhone 12</div>
            <div class="col"><i class="bi bi-dot"></i> iPhone 12 Mini</div>
            <div class="col"><i class="bi bi-dot"></i> iPhone 12 Pro</div>
            <div class="col"><i class="bi bi-dot"></i> iPhone 12 Pro Max</div>
            <div class="col"><i class="bi bi-dot"></i> iPhone 14 Pro Max</div>
            <div class="col"><i class="bi bi-dot"></i> iPhone 14 Plus</div>
            <div class="col"><i class="bi bi-dot"></i> iPhone 14 Pro</div>
            <div class="col"><i class="bi bi-dot"></i> Samsung S25 Edge</div>
            <div class="col"><i class="bi bi-dot"></i> ƒêi·ªán Tho·∫°i iPhone C≈©</div>
            <div class="col"><i class="bi bi-dot"></i> D√†n karaoke c≈©</div>
            <div class="col"><i class="bi bi-dot"></i> Tivi c≈© gi√° r·∫ª</div>
            <div class="col"><i class="bi bi-dot"></i> iPhone 16e</div>
            <div class="col"><i class="bi bi-dot"></i> ƒêi·ªán tho·∫°i Samsung C≈©</div>
            <div class="col"><i class="bi bi-dot"></i> M√°y t√≠nh ƒë·ªÉ b√†n gi√° r·∫ª</div>
            <div class="col"><i class="bi bi-dot"></i> ·ªêng k√≠nh (lens) c≈©</div>
            <div class="col"><i class="bi bi-dot"></i> M√°y ·∫£nh c≈©</div>
            <div class="col"><i class="bi bi-dot"></i> M√°y quay c≈©</div>
            <div class="col"><i class="bi bi-dot"></i> Micro c≈©</div>
            <div class="col"><i class="bi bi-dot"></i> Tai Nghe C≈©</div>
            <div class="col"><i class="bi bi-dot"></i> Amply</div>
            <div class="col"><i class="bi bi-dot"></i> Loa C≈©</div>
            <div class="col"><i class="bi bi-dot"></i> M√°y t√≠nh ƒë·ªÉ b√†n c≈©</div>
            <div class="col"><i class="bi bi-dot"></i> M√°y T√≠nh B·∫£ng C≈©</div>
            <div class="col"><i class="bi bi-dot"></i> Laptop C≈©</div>
            <div class="col"><i class="bi bi-dot"></i> ƒêi·ªán Tho·∫°i C≈©</div>
            <div class="col"><i class="bi bi-dot"></i> Macbook</div>
        </div>
    </div>
</div>

<!-- Hidden Form for Sorting -->
<form method="get" asp-action="Index" id="filterForm" style="display:none;">
    <input type="hidden" name="query" value="@ViewBag.CurrentQuery" />
    <input type="hidden" name="sortBy" value="@ViewBag.SortBy" />
    <input type="hidden" name="categoryId" value="@ViewBag.CurrentCategory" />
    <input type="hidden" name="page" value="@ViewBag.CurrentPage" />
</form>

<script>
    function updateSort(value) {
        var form = document.getElementById('filterForm');
        var input = form.querySelector('input[name="sortBy"]');
        input.value = value;
        // Reset page to 1 when sorting changes
        form.querySelector('input[name="page"]').value = 1;
        loadProducts();
    }

    function changePage(page) {
        var form = document.getElementById('filterForm');
        var input = form.querySelector('input[name="page"]');
        input.value = page;
        loadProducts();
    }

    function loadProducts() {
        var form = document.getElementById('filterForm');
        var formData = new FormData(form);
        var params = new URLSearchParams(formData);

        // Update URL without reloading
        window.history.pushState({}, '', '?' + params.toString());

        fetch('/Home/Index?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('product-grid-section').innerHTML = html;
            
            // Update pagination info in the sort bar
            var currentPage = parseInt(document.getElementById('hidden-current-page').value);
            var totalPages = parseInt(document.getElementById('hidden-total-pages').value);
            var sortBy = document.getElementById('hidden-sort-by').value;

            // Update Page Count Text
            var pageCountSpan = document.querySelector('.ms-auto .text-danger');
            if(pageCountSpan) pageCountSpan.innerText = currentPage;
            
            var totalPageSpan = document.querySelector('.ms-auto span.me-3');
            if(totalPageSpan) totalPageSpan.innerHTML = `<span class="text-danger fw-bold">${currentPage}</span>/${totalPages}`;

            // Update Prev/Next Buttons
            var btnGroup = document.querySelector('.ms-auto .btn-group');
            if(btnGroup) {
                var prevBtn = btnGroup.children[0];
                var nextBtn = btnGroup.children[1];

                prevBtn.disabled = currentPage <= 1;
                prevBtn.setAttribute('onclick', `changePage(${currentPage - 1})`);

                nextBtn.disabled = currentPage >= totalPages;
                nextBtn.setAttribute('onclick', `changePage(${currentPage + 1})`);
            }

            // Update Sort Buttons Active State
            var sortButtons = document.querySelectorAll('.d-flex.align-items-center.bg-light button.btn');
            sortButtons.forEach(btn => {
                // Reset all to white
                if (!btn.classList.contains('dropdown-toggle')) {
                    btn.className = 'btn btn-white bg-white text-dark me-2';
                }
            });

            // Set active button
            if (sortBy === 'popular' || !sortBy) {
                document.querySelector('button[onclick="updateSort(\'popular\')"]').className = 'btn btn-danger text-white me-2';
            } else if (sortBy === 'newest') {
                document.querySelector('button[onclick="updateSort(\'newest\')"]').className = 'btn btn-danger text-white me-2';
            } else if (sortBy === 'best_selling') {
                document.querySelector('button[onclick="updateSort(\'best_selling\')"]').className = 'btn btn-danger text-white me-2';
            }
            
            // Update Dropdown Text
            var dropdownBtn = document.getElementById('priceSortDropdown');
            if(dropdownBtn) {
                if(sortBy === 'price_asc') dropdownBtn.innerText = 'Gi√°: Th·∫•p ƒë·∫øn Cao';
                else if(sortBy === 'price_desc') dropdownBtn.innerText = 'Gi√°: Cao ƒë·∫øn Th·∫•p';
                else dropdownBtn.innerText = 'Gi√°';
            }

        })
        .catch(error => console.error('Error loading products:', error));
    }

    // Hero Search Bar Dropdown Handlers
    document.addEventListener('DOMContentLoaded', function() {
        // Category Dropdown
        document.querySelectorAll('#categoryDropdownHero + .dropdown-menu .dropdown-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const categoryId = this.getAttribute('data-category');
                const categoryName = this.textContent.trim();
                document.getElementById('categoryIdHero').value = categoryId;
                document.getElementById('selectedCategoryHero').textContent = categoryName;
            });
        });

        // Location Dropdown - Quick Buttons
        document.querySelectorAll('.location-quick-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const location = this.getAttribute('data-location');
                document.getElementById('locationHero').value = location;
                document.getElementById('selectedLocationHero').textContent = location;
            });
        });

        // Location Dropdown - List Items
        document.querySelectorAll('#locationDropdownHero + .dropdown-menu .list-group-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const location = this.getAttribute('data-location');
                const locationName = this.textContent.trim();
                document.getElementById('locationHero').value = location;
                document.getElementById('selectedLocationHero').textContent = locationName || 'To√†n qu·ªëc';
            });
        });
    });

    // Filter by Category with AJAX
    function filterByCategory(categoryName) {
        const url = new URL(window.location.href);
        
        if (categoryName === 'T·∫•t c·∫£ danh m·ª•c') {
            url.searchParams.delete('category');
        } else {
            url.searchParams.set('category', categoryName);
        }
        
        // Update URL without reload
        window.history.pushState({}, '', url.toString());
        
        // Load products via AJAX
        fetch(url.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('product-grid-section').innerHTML = html;
            
            // Scroll to products section
            document.getElementById('product-grid-section').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => console.error('Error filtering products:', error));
    }
</script>

@{
    var nextHoliday = ViewBag.NextHoliday as MegaMall.Interfaces.HolidayEvent;
    var hasActiveCoupons = activeCoupons != null && activeCoupons.Any();
    var hasUpcomingHoliday = nextHoliday != null && nextHoliday.DaysUntil <= 30;
}

<!-- Voucher Splash Popup (Fullscreen) -->
@if (hasActiveCoupons || hasUpcomingHoliday)
{
<div id="voucherSplashModal" class="voucher-splash-overlay" style="display: none;">
    <div class="voucher-splash-container">
        <!-- Close Button -->
        <button type="button" class="voucher-splash-close" onclick="closeVoucherSplash()">
            <i class="bi bi-x-lg"></i>
        </button>

        <!-- Header -->
        <div class="voucher-splash-header">
            <div class="voucher-splash-icon">
                <i class="bi bi-gift-fill"></i>
            </div>
            <h2 class="voucher-splash-title">KHUY·∫æN M√ÉI ƒê·∫∂C BI·ªÜT</h2>
            <p class="voucher-splash-subtitle">Nh·∫≠n ngay voucher h·∫•p d·∫´n h√¥m nay!</p>
            
            @if (hasUpcomingHoliday)
            {
                <div class="holiday-announcement">
                    <i class="bi bi-calendar-heart-fill me-2"></i>
                    <span>
                        <strong>S·∫Øp t·ªõi l√† @nextHoliday.Name (@nextHoliday.Date.ToString("dd/MM/yyyy"))</strong> - 
                        H√£y ch·ªù ƒë·ª£i h√†ng lo·∫°t voucher kh·ªßng v·ªõi ∆∞u ƒë√£i l√™n ƒë·∫øn <strong class="highlight-percent">70%</strong>! 
                        C√≤n <strong class="countdown-badge">@nextHoliday.DaysUntil ng√†y</strong> n·ªØa th√¥i! üéâ
                    </span>
                </div>
            }
        </div>

        <!-- Voucher Cards Grid -->
        @if (hasActiveCoupons)
        {
        <div class="voucher-splash-grid">
            @foreach (var coupon in activeCoupons.Take(6))
            {
                var couponClass = coupon.Type == MegaMall.Domain.Enums.CouponType.FreeShipping ? "freeship" : "discount";
                <div class="voucher-splash-card voucher-type-@couponClass" onclick="copyVoucherCode('@coupon.Code', this)">
                    <div class="voucher-card-left">
                        <div class="voucher-card-icon">
                            @if (coupon.Type == MegaMall.Domain.Enums.CouponType.FreeShipping)
                            {
                                <i class="bi bi-truck"></i>
                            }
                            else
                            {
                                <i class="bi bi-ticket-perforated"></i>
                            }
                        </div>
                        <div class="voucher-card-info">
                            <div class="voucher-card-title">@coupon.Code</div>
                            <div class="voucher-card-desc">
                                @if (coupon.Type == MegaMall.Domain.Enums.CouponType.FixedAmount)
                                {
                                    <text>Gi·∫£m @coupon.DiscountValue.ToString("N0")ƒë</text>
                                }
                                else if (coupon.Type == MegaMall.Domain.Enums.CouponType.Percentage)
                                {
                                    <text>Gi·∫£m @coupon.DiscountValue% - T·ªëi ƒëa @(coupon.MaxDiscountAmount?.ToString("N0") ?? "‚àû")ƒë</text>
                                }
                                else
                                {
                                    <text>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</text>
                                }
                            </div>
                            @if (coupon.MinOrderAmount > 0)
                            {
                                <div class="voucher-card-condition">ƒê∆°n t·ªëi thi·ªÉu @coupon.MinOrderAmount.ToString("N0")ƒë</div>
                            }
                        </div>
                    </div>
                    <div class="voucher-card-right">
                        <button type="button" class="voucher-copy-btn">
                            <i class="bi bi-clipboard"></i>
                            <span>Sao ch√©p</span>
                        </button>
                    </div>
                    <div class="voucher-card-ribbon">
                        @if (coupon.StartDate > DateTime.Now)
                        {
                            <span style="background: #ffc107; color: #000;">S·∫Øp di·ªÖn ra</span>
                        }
                        else
                        {
                            <span>C√≤n @((coupon.Quantity ?? 999) - coupon.UsedCount) l∆∞·ª£t</span>
                        }
                    </div>
                </div>
            }
        </div>
        }

        <!-- Footer -->
        <div class="voucher-splash-footer">
            <button type="button" class="btn btn-light btn-lg px-5" onclick="closeVoucherSplash()">
                Ti·∫øp t·ª•c mua s·∫Øm
            </button>
            <p class="mt-3 text-white small mb-0">
                <i class="bi bi-info-circle"></i> √Åp d·ª•ng m√£ t·∫°i trang thanh to√°n
            </p>
        </div>
    </div>
</div>

<script>
    // Auto show voucher splash on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if splash was already shown
        if (!sessionStorage.getItem('voucherSplashShown')) {
            setTimeout(function() {
                var modal = document.getElementById('voucherSplashModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }, 500); // Show after 500ms
        }
    });

    function closeVoucherSplash() {
        document.getElementById('voucherSplashModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        sessionStorage.setItem('voucherSplashShown', 'true');
    }

    function copyVoucherCode(code, element) {
        navigator.clipboard.writeText(code).then(function() {
            var btn = element.querySelector('.voucher-copy-btn');
            var originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="bi bi-check-circle-fill"></i><span>ƒê√£ sao ch√©p!</span>';
            btn.classList.add('copied');
            
            setTimeout(function() {
                btn.innerHTML = originalHTML;
                btn.classList.remove('copied');
            }, 2000);

            // Show toast notification
            showToast('ƒê√£ sao ch√©p m√£ ' + code);
        });
    }

    function showToast(message) {
        var toast = document.createElement('div');
        toast.className = 'voucher-toast';
        toast.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>' + message;
        document.body.appendChild(toast);
        
        setTimeout(function() {
            toast.classList.add('show');
        }, 100);
        
        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() {
                document.body.removeChild(toast);
            }, 300);
        }, 2500);
    }

    // Close on background click
    document.addEventListener('click', function(e) {
        var modal = document.getElementById('voucherSplashModal');
        if (modal && e.target === modal) {
            closeVoucherSplash();
        }
    });

    // Close on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var modal = document.getElementById('voucherSplashModal');
            if (modal && modal.style.display === 'flex') {
                closeVoucherSplash();
            }
        }
    });
</script>
}


